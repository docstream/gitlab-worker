machine:
  services:
    - docker
  environment:
    AWS_ECR : 945120944185.dkr.ecr.eu-central-1.amazonaws.com
    APP : msg-actors

dependencies:
  override:
    - docker info
    - docker build --rm=false -t $AWS_ECR/$APP:$CIRCLE_BRANCH .

test:
  override:
    - docker run -d --name queue rabbitmq:3 ; sleep 20
    - docker run --rm -ti
      --link queue:queue
      --entrypoint '/bin/bash'
      $AWS_ECR/$APP:$CIRCLE_BRANCH 
      exercise.sh
    - docker logs queue
      

deployment:
  prod:
    branch: [master,dev,unstable]
    commands:
      - aws/deploy.sh
